name: Sync from Secondary Repo & Restore Point

on:
  workflow_dispatch: # Avvio manuale

permissions:
  contents: write

jobs:
  sync-and-backup:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout della Repo Principale (Destinazione)
      - name: Checkout Primary Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_PAT }}
          fetch-depth: 0

      # 2. Configurazione Git
      - name: Setup Git User
        run: |
          git config --global user.name "Sync Bot"
          git config --global user.email "bot@github.com"

      # 3. CREAZIONE PUNTO DI RIPRISTINO (Backup Branch)
      - name: Create Restore Point
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          BACKUP_BRANCH="backup/pre-sync-$TIMESTAMP"
          echo "Creazione punto di ripristino: $BACKUP_BRANCH"
          git checkout -b $BACKUP_BRANCH
          git push origin $BACKUP_BRANCH
          # Torna al main per applicare le modifiche
          git checkout main

      # 4. Checkout della Repo Secondaria (Sorgente)
      - name: Checkout Secondary Repo
        uses: actions/checkout@v4
        with:
          repository: jerbamichol-del/prova  # <--- TUA REPO SECONDARIA
          token: ${{ secrets.MY_PAT }}
          path: temp-source

      # 5. Trasferimento Chirurgico dei File (CORRETTO SENZA SRC)
      - name: Copy Specific Files
        run: |
          # Funzione corretta: Cerca nella root di temp-source, copia in src/ della principale
          copy_file() {
            # $1 Ã¨ il percorso relativo (es. "components/Dashboard.tsx")
            
            SOURCE_FILE="temp-source/$1"  # <--- MODIFICA QUI: Tolto /src/
            DEST_FILE="src/$1"            # Destinazione rimane in src/

            if [ -f "$SOURCE_FILE" ]; then
              # Crea la cartella di destinazione se non esiste
              mkdir -p "$(dirname "$DEST_FILE")"
              cp "$SOURCE_FILE" "$DEST_FILE"
              echo "âœ… Copiato: $1"
            else
              echo "âš ï¸ File non trovato nella sorgente: $1 (Cercato in: $SOURCE_FILE)"
            fi
          }

          echo "Inizio trasferimento file..."
          
          # --- LISTA FILE ---
          
          # Root (App.tsx va in src/App.tsx)
          copy_file "App.tsx"
          
          # Components
          copy_file "components/CalculatorContainer.tsx"
          copy_file "components/ExpenseList.tsx"
          copy_file "components/ImageParserModal.tsx"
          copy_file "components/CategoryFilter.tsx"
          copy_file "components/TrapezoidTab.tsx"
          copy_file "components/TrapezoidTabRight.tsx"
          copy_file "components/SoftTab.tsx"
          copy_file "components/SoftBumpBaseline.tsx"
          copy_file "components/EdgeSwipeCatcher.tsx"
          copy_file "components/Dashboard.tsx"
          copy_file "components/TransactionDetailPage.tsx"
          copy_file "components/ExpenseForm.tsx"
          
          # Hooks
          copy_file "hooks/useLeftSwipeFromRightEdge.ts"
          copy_file "hooks/useLeftSwipeFromRightEdge_v2.ts"
          copy_file "hooks/useSwipeDownCloseAtTop.ts"
          copy_file "hooks/useLongPress.ts"
          copy_file "hooks/useRecurringExpenseGenerator.ts"
          copy_file "hooks/useCloudSync.ts"
          copy_file "hooks/usePendingImages.ts"
          copy_file "hooks/useInstallPrompt.ts"
          copy_file "hooks/usePrivacyGate.ts"
          copy_file "hooks/useBackNavigation.ts"
          
          # Utils & Types
          copy_file "utils/date.ts"
          copy_file "utils/cloud.ts"
          copy_file "types/navigation.ts"
          
          # Screens
          copy_file "screens/HistoryScreen.tsx"
          copy_file "screens/RecurringExpensesScreen.tsx"

          # Pulizia
          rm -rf temp-source

      # 6. Commit e Push
      - name: Commit and Push Changes
        run: |
          git add .
          # Se non ci sono differenze, non fallisce
          git commit -m "ðŸ”„ Sync automatico da Repo Secondaria (Root Fix)" || echo "Nessuna modifica da committare"
          git push origin main
