name: Sync from Secondary Repo & Restore Point

on:
  workflow_dispatch: # Avvio manuale

permissions:
  contents: write

jobs:
  sync-and-backup:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout della Repo Principale (Destinazione)
      - name: Checkout Primary Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_PAT }}
          fetch-depth: 0

      # 2. Configurazione Git
      - name: Setup Git User
        run: |
          git config --global user.name "Sync Bot"
          git config --global user.email "bot@github.com"

      # 3. CREAZIONE PUNTO DI RIPRISTINO (Backup Branch)
      - name: Create Restore Point
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          BACKUP_BRANCH="backup/pre-sync-$TIMESTAMP"
          echo "Creazione punto di ripristino: $BACKUP_BRANCH"
          git checkout -b $BACKUP_BRANCH
          git push origin $BACKUP_BRANCH
          # Torna al main per applicare le modifiche
          git checkout main

      # 4. Checkout della Repo Secondaria (Sorgente)
      - name: Checkout Secondary Repo
        uses: actions/checkout@v4
        with:
          repository: jerbamichol-del/prova  # <--- TUA REPO SECONDARIA
          token: ${{ secrets.MY_PAT }}
          path: temp-source

      # 5. Trasferimento Chirurgico dei File
      - name: Copy Specific Files
        run: |
          # Funzione di copia
          copy_file() {
            SOURCE_FILE="temp-source/$1"
            DEST_FILE="src/$1"
            # Se Ã¨ App.tsx Ã¨ nella root di src, se Ã¨ altro mantiene il path
            if [ "$1" == "App.tsx" ]; then
                DEST_FILE="src/App.tsx"
            fi

            if [ -f "$SOURCE_FILE" ]; then
              mkdir -p "$(dirname "$DEST_FILE")"
              cp "$SOURCE_FILE" "$DEST_FILE"
              echo "âœ… Copiato: $1"
            else
              echo "âš ï¸ File non trovato nella sorgente: $1"
            fi
          }

          echo "Inizio trasferimento file..."
          
          # --- LISTA COMPLETA FILE DA AGGIORNARE ---

          # Core
          copy_file "App.tsx"

          # Components - Core & UI
          copy_file "components/Dashboard.tsx"
          copy_file "components/ExpenseForm.tsx"
          copy_file "components/ExpenseList.tsx"
          copy_file "components/TransactionDetailPage.tsx"
          copy_file "components/CalculatorContainer.tsx"
          copy_file "components/InteractiveLegend.tsx"
          copy_file "components/BottomNavigationBar.tsx"
          copy_file "components/ImageParserModal.tsx"
          copy_file "components/CategoryFilter.tsx"
          copy_file "components/PendingImages.tsx"
          
          # Components - Tabs & Effects
          copy_file "components/TrapezoidTab.tsx"
          copy_file "components/TrapezoidTabRight.tsx"
          copy_file "components/SoftTab.tsx"
          copy_file "components/SoftBumpBaseline.tsx"
          copy_file "components/EdgeSwipeCatcher.tsx"

          # Screens
          copy_file "screens/HistoryScreen.tsx"
          copy_file "screens/RecurringExpensesScreen.tsx"
          copy_file "screens/CategoryDetailScreen.tsx"
          copy_file "screens/ForgotEmailScreen.tsx"

          # Utils
          copy_file "utils/cloud.ts"
          copy_file "utils/date.ts"

          # Types
          copy_file "types/navigation.ts"

          # Hooks
          copy_file "hooks/useLeftSwipeFromRightEdge.ts"
          copy_file "hooks/useLeftSwipeFromRightEdge_v2.ts"
          copy_file "hooks/useSwipeDownCloseAtTop.ts"
          copy_file "hooks/useLongPress.ts"
          copy_file "hooks/useRecurringExpenseGenerator.ts"
          copy_file "hooks/useCloudSync.ts"
          copy_file "hooks/usePendingImages.ts"
          copy_file "hooks/useInstallPrompt.ts"
          copy_file "hooks/usePrivacyGate.ts"
          copy_file "hooks/useBackNavigation.ts"

          # Pulizia
          rm -rf temp-source

      # 6. Commit e Push
      - name: Commit and Push Changes
        run: |
          git add .
          git commit -m "ðŸ”„ Sync Completo da Repo Secondaria (Nuova Struttura)" || echo "Nessuna modifica da committare"
          git push origin main
