<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reimposta PIN</title>
  <script>
  (function () {
    // ENDPOINT Apps Script (già deployato)
    var ENDPOINT = "https://script.google.com/macros/s/AKfycbzmq-PTrMcMdrYqCRX29_S034zCaj5ttyc3tZhdhjV77wF6n99LKricFgzy7taGqKOo/exec";

    function jsonp(url, cb) {
      var c = "__rp_" + Date.now() + Math.random().toString(36).slice(2);
      window[c] = function (d) { try { delete window[c]; } catch(_) {} s.remove(); cb(d); };
      var s = document.createElement("script");
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + c;
      s.onerror = function(){ try { delete window[c]; } catch(_) {} s.remove(); cb({ ok:false, error:"NETWORK" }); };
      document.head.appendChild(s);
    }

    function getParam(keys) {
      var sp = new URL(location.href).searchParams;
      for (var i=0;i<keys.length;i++) { var v = sp.get(keys[i]); if (v) return v; }
      return null;
    }

    // 1) Prendi token ed email (accettiamo t/token/code/k per compat vecchie mail)
    var token = getParam(["t","token","code","k","resetToken"]);
    var email = getParam(["email","e"]);
    if (!token || !email) {
      // Fallback: torna all'app comunque (aprirà login)
      location.replace("https://jerbamichol-del.github.io/gestore/");
      return;
    }

    // 2) Consuma il token (opzionale ma consigliato)
    jsonp(ENDPOINT + "?action=consume&t=" + encodeURIComponent(token), function (_res) {
      // 3) Reindirizza alla PWA con i parametri che la tua app si aspetta
      var target = "https://jerbamichol-del.github.io/gestore/?resetToken=" +
                   encodeURIComponent(token) + "&email=" + encodeURIComponent(email);
      location.replace(target);
    });
  })();
  </script>
  <style>
    html,body{height:100%;margin:0}
    body{display:flex;align-items:center;justify-content:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .card{padding:16px 20px;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
  </style>
</head>
<body>
  <div class="card">Reindirizzamento…</div>
</body>
</html>
