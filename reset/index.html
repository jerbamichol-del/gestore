<!doctype html><html lang="it"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Reimposta PIN</title>
<style>body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial} .box{max-width:480px;margin:12vh auto;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:24px}</style>
</head>
<body style="background:#f1f5f9;padding:16px">
  <main class="box">
    <h1 style="font-size:20px;margin:0 0 12px">Reimposta PIN</h1>
    <div id="msg">Verifica del link…</div>
    <div id="ok" style="display:none;margin-top:10px">
      <p>Il link è valido. Premi “Conferma” per procedere al reset.</p>
      <button id="go" style="padding:10px 12px;border-radius:10px;background:#4f46e5;color:#fff;border:0">Conferma reset</button>
      <p style="font-size:12px;color:#475569;margin-top:10px">Dopo la conferma, torna nell’app <b>Gestore Spese</b> e imposta un nuovo PIN.</p>
    </div>
  </main>
  <script>
  (function(){
    var ENDPOINT="https://script.google.com/macros/s/AKfycbzmq-PTrMcMdrYqCRX29_S034zCaj5ttyc3tZhdhjV77wF6n99LKricFgzy7taGqKOo/exec";
    function jsonp(url, cb){
      var c='__rp_'+Date.now()+Math.random().toString(36).slice(2);
      window[c]=function(d){ try{delete window[c];}catch(_){}
        s.remove(); cb(d);
      };
      var s=document.createElement('script');
      s.src=url+(url.includes('?')?'&':'?')+'callback='+c;
      s.onerror=function(){ try{delete window[c];}catch(_){}
        s.remove(); cb({ok:false,error:'NETWORK'});
      };
      document.head.appendChild(s);
    }
    var t = new URL(location.href).searchParams.get('t') || new URL(location.href).searchParams.get('token');
    var msg = document.getElementById('msg'), ok = document.getElementById('ok');
    function showInvalid(){ ok.style.display='none'; msg.style.display='block'; msg.textContent='Link non valido o scaduto.'; }
    function showValid(){ msg.style.display='none'; ok.style.display='block'; }
    if(!ENDPOINT || !t){ showInvalid(); return; }
    jsonp(ENDPOINT+'?action=validate&t='+encodeURIComponent(t), function(v){
      if(!(v&&v.ok)){ showInvalid(); return; }
      showValid();
      document.getElementById('go').onclick=function(){
        jsonp(ENDPOINT+'?action=consume&t='+encodeURIComponent(t), function(c){
          if(c&&c.ok){
            try{ localStorage.setItem('gs_force_new_pin','1'); }catch(e){}
            // torna all'app
            var base = location.origin + '/gestore/';
            location.href = base;
          }else{
            showInvalid();
          }
        });
      };
    });
  })();
  </script>
</body></html>