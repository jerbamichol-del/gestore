<!doctype html><html lang="it"><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reimposta PIN</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.13/dist/tailwind.min.css">
<div class="min-h-screen flex items-center justify-center bg-slate-100 p-4">
  <div class="w-full max-w-md bg-white shadow-xl rounded-2xl p-6 space-y-4">
    <h1 class="text-xl font-semibold text-slate-900">Reimposta PIN</h1>
    <div id="msg" class="text-slate-700">Verifica del link…</div>
    <div id="ok" class="hidden space-y-3">
      <p class="text-slate-700">Il link è valido. Premi “Conferma” per procedere al reset.</p>
      <button id="go" class="w-full rounded-lg py-2 bg-indigo-600 text-white">Conferma reset</button>
      <p class="text-xs text-slate-500">Dopo la conferma, torna nell’app <b>Gestore Spese</b> e imposta un nuovo PIN.</p>
    </div>
  </div>
</div>
<script>
  var ENDPOINT='https://script.google.com/macros/s/AKfycbyE3eTfSyJpRHX1hlmO8vv6H55SvovcH4kwEXAOjWez1tkYrzOwhNCGeucddAQfj_XUTw/exec';
  function jsonp(url, cb){
    var c='__rp_'+Date.now()+Math.random().toString(36).slice(2);
    window[c]=function(d){ try{delete window[c];}catch(_){}
      s.remove(); cb(d);
    };
    var s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+c;
    s.onerror=function(){ try{delete window[c];}catch(_){}
      s.remove(); cb({ok:false,error:'NETWORK'});
    };
    document.head.appendChild(s);
  }
  var t = new URL(location.href).searchParams.get('t');
  var msg = document.getElementById('msg'), ok = document.getElementById('ok');
  if(!t){ msg.textContent='Link non valido.'; }
  else {
    jsonp(ENDPOINT+'?action=validate&t='+encodeURIComponent(t), function(v){
      if(!(v&&v.ok)){ msg.textContent='Link non valido o scaduto.'; return; }
      msg.classList.add('hidden'); ok.classList.remove('hidden');
      document.getElementById('go').onclick=function(){
        jsonp(ENDPOINT+'?action=consume&t='+encodeURIComponent(t), function(c){
          if(c&&c.ok){ msg.classList.remove('hidden'); ok.classList.add('hidden'); msg.textContent='Reset confermato. Ora riapri l’app e imposta un nuovo PIN.'; }
          else { msg.textContent='Qualcosa è andato storto. Riprova.'; }
        });
      };
    });
  }
</script>