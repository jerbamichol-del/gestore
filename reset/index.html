<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reimposta PIN</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="max-w-lg mx-auto px-4 py-10">
    <h1 class="text-2xl font-semibold mb-3">Reimposta PIN</h1>

    <div id="status" class="rounded-xl border bg-white p-4 shadow-sm">
      <p id="msg" class="text-slate-700">Verifica link in corso…</p>
      <div id="ok" class="hidden mt-4">
        <button id="confirmBtn"
                class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
          Conferma reset
        </button>
        <p class="text-sm text-slate-500 mt-3">
          Dopo la conferma, torna nell’app Gestore Spese e imposta un nuovo PIN.
        </p>
      </div>
    </div>

    <div class="mt-8 text-sm text-slate-500">
      Se il link risultasse scaduto, richiedi nuovamente il reset dall’app.
    </div>
  </div>

  <script>
  (function () {
    // ✅ Tuo endpoint Apps Script (quello nuovo)
    const API = "https://script.google.com/macros/s/AKfycbzmq-PTrMcMdrYqCRX29_S034zCaj5ttyc3tZhdhjV77wF6n99LKricFgzy7taGqKOo/exec";

    const qs = new URLSearchParams(location.search);
    const token = qs.get("token");

    const msg = document.getElementById("msg");
    const okBox = document.getElementById("ok");
    const confirmBtn = document.getElementById("confirmBtn");

    if (!token) {
      msg.textContent = "Link non valido o scaduto.";
      return;
    }

    // 1) Verifica token
    fetch(API + "?action=verify&token=" + encodeURIComponent(token), { cache: "no-store" })
      .then(r => r.json())
      .then(j => {
        if (j && j.ok && j.valid) {
          msg.textContent = "Il link è valido. Premi “Conferma” per procedere al reset.";
          okBox.classList.remove("hidden");
        } else {
          msg.textContent = "Link non valido o scaduto.";
        }
      })
      .catch(() => {
        msg.textContent = "Impossibile verificare il link (connessione o server). Riprova.";
      });

    // 2) Conferma reset
    confirmBtn.addEventListener("click", () => {
      confirmBtn.disabled = true;
      confirmBtn.textContent = "Confermo…";

      fetch(API + "?action=confirm&token=" + encodeURIComponent(token), { cache: "no-store" })
        .then(r => r.json())
        .then(j => {
          if (j && j.ok && j.confirmed) {
            msg.textContent = "Reset confermato! Torna all’app e imposta il nuovo PIN.";
            okBox.classList.add("hidden");
          } else {
            msg.textContent = "Link non valido o scaduto.";
            okBox.classList.add("hidden");
          }
        })
        .catch(() => {
          msg.textContent = "Errore di rete. Riprova.";
        })
        .finally(() => {
          confirmBtn.disabled = false;
          confirmBtn.textContent = "Conferma reset";
        });
    });
  })();
  </script>
</body>
</html>
