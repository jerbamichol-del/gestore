<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reimposta PIN</title>
  <link rel="manifest" href="/gestore/manifest.json" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f1f5f9; } /* slate-100 */
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6">
    <h1 class="text-2xl font-semibold text-slate-900">Reimposta PIN</h1>

    <div id="state" class="mt-4 text-slate-700">
      Controllo del link in corso…
    </div>

    <div id="actions" class="mt-6 hidden">
      <button id="confirmBtn"
        class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition">
        Conferma reset
      </button>
    </div>

    <div class="mt-6 text-sm text-slate-500">
      Dopo la conferma, torna nell’app <strong>Gestore Spese</strong> e imposta un nuovo PIN.
    </div>
  </div>

  <script>
    // <-- Inserisci qui il TUO nuovo GAS URL -->
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzmq-PTrMcMdrYqCRX29_S034zCaj5ttyc3tZhdhjV77wF6n99LKricFgzy7taGqKOo/exec";

    const elState = document.getElementById('state');
    const elActions = document.getElementById('actions');
    const btnConfirm = document.getElementById('confirmBtn');

    const params = new URLSearchParams(location.search);
    const token = params.get('token') || params.get('t');

    async function verify() {
      if (!token) {
        elState.innerHTML = "Link non valido o mancante. Riprova dalla mail di reset.";
        return;
      }
      try {
        const r = await fetch(`${GAS_URL}?action=verify&token=${encodeURIComponent(token)}`, { cache: 'no-store' });
        const ok = r.ok ? await r.json().catch(()=>null) : null;
        if (ok && (ok.valid === true || ok.status === 'valid')) {
          elState.innerHTML = 'Il link è valido. Premi “Conferma” per procedere al reset.';
          elActions.classList.remove('hidden');
        } else {
          elState.innerHTML = 'Link non valido o scaduto.';
        }
      } catch (e) {
        elState.innerHTML = 'Impossibile contattare il server. Riprova più tardi.';
      }
    }

    async function confirmReset() {
      btnConfirm.disabled = true;
      btnConfirm.textContent = 'Confermo…';
      try {
        // Prova "confirm", poi fallback "consume"
        let r = await fetch(`${GAS_URL}?action=confirm&token=${encodeURIComponent(token)}`, { cache: 'no-store' });
        if (!r.ok) {
          r = await fetch(`${GAS_URL}?action=consume&token=${encodeURIComponent(token)}`, { cache: 'no-store' });
        }
        if (r.ok) {
          elState.innerHTML = 'Reset confermato. Puoi tornare nell’app e impostare un nuovo PIN.';
          elActions.classList.add('hidden');
        } else {
          elState.innerHTML = 'Errore durante la conferma. Forse il link è scaduto.';
        }
      } catch (e) {
        elState.innerHTML = 'Errore di rete durante la conferma. Riprova.';
      } finally {
        btnConfirm.disabled = false;
        btnConfirm.textContent = 'Conferma reset';
      }
    }

    btnConfirm.addEventListener('click', confirmReset);
    verify();
  </script>
</body>
</html>
